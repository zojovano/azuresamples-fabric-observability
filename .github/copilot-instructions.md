# Copilot Instructions for Azure### **Fabric Deployment: Git Integration Pattern (Current Approach)**
**Since September 2025, the project uses a Git-based deployment approach that eliminates API complexity:**

**How Git Integration Works:**
1. **Table definitions stored in**: `deploy/fabric-artifacts/tables/*.kql`
2. **Fabric workspace connected to**: Git repository folder `deploy/fabric-artifacts/`
3. **Deployment method**: Fabric automatically syncs changes from Git
4. **No API calls needed**: Git handles all synchronization

**Git Integration Benefits:**
- ✅ **No authentication complexity** - No Fabric API auth issues
- ✅ **Automatic version control** - All changes tracked in Git history
- ✅ **Reliable deployment** - Fabric handles sync robustly
- ✅ **Collaborative development** - Multiple developers can work together
- ✅ **Visual feedback** - Fabric portal shows Git status and sync history
- ✅ **Easy rollback** - Git provides complete change history

**Deployment Process:**
```powershell
# 1. Update table definitions in Git folder (already done)
edit deploy/fabric-artifacts/tables/otel-logs.kql

# 2. Commit changes to Git (already done)
git add . && git commit -m "Update schema" && git push

# 3. Run simplified deployment script
./deploy/infra/Deploy-FabricArtifacts-Git.ps1

# 4. Optional: Automated sync (requires Fabric CLI auth)
./deploy/infra/Deploy-FabricArtifacts-Git.ps1 -TriggerSync
```

**Key Git Integration Files:**
- `deploy/fabric-artifacts/tables/*.kql` - Table schema definitions
- `deploy/fabric-artifacts/README.md` - Git setup documentation  
- `Deploy-FabricArtifacts-Git.ps1` - **Simplified guidance and optional sync script**
- `deploy/README.md` - Comprehensive deployment documentation

**Fabric Workspace Structure After Git Integration:**
```
deploy/fabric-artifacts/
├── README.md
├── tables/
│   ├── otel-logs.kql
│   ├── otel-metrics.kql
│   └── otel-traces.kql
└── otelobservabilitydb_auto.Eventhouse/  # Auto-generated by Fabric
    ├── .platform
    ├── EventhouseProperties.json
    └── .children/
        ├── otelobservabilitydb.KQLDatabase/
        │   ├── .platform
        │   ├── DatabaseProperties.json
        │   └── DatabaseSchema.kql  # Contains actual table definitions
        └── otelobservabilitydb_auto.KQLDatabase/
```

### **Git Integration Deployment Pattern**
**Current approach (September 2025+)**: All Fabric artifacts deployment uses Git integration with **simplified guidance script**.

**How it works:**
1. **Schema storage**: Table definitions in `deploy/fabric-artifacts/tables/*.kql`
2. **Git connection**: Fabric workspace connected to `deploy/fabric-artifacts/` folder
3. **Guidance script**: `Deploy-FabricArtifacts-Git.ps1` provides step-by-step instructions
4. **Optional automation**: `-TriggerSync` parameter attempts automated Git sync via Azure CLI
5. **No complex searches**: Git integration handles workspace automatically

**Deployment script purpose:**
- `Deploy-FabricArtifacts-Git.ps1` - **Simplified guidance and optional automated sync**
- **Primary function**: Verify Git folder structure and provide clear deployment steps
- **Secondary function**: Optional automated sync via Azure CLI (if Fabric CLI authenticated)
- **NOT for workspace searching** - Git integration handles workspace automatically
- **NOT for complex API-based deployment** - Git sync replaces complex API calls

**When to use manual vs automated sync:**
- **Manual sync** (recommended): Use Fabric portal Source Control panel for reliable deployment
- **Automated sync** (optional): Use `-TriggerSync` parameter if Fabric CLI is authenticated and Azure CLI available
- **Guidance-only**: Run script without parameters for step-by-step instructions

## Architecture Overview

This is an **OTEL Gateway deployment pattern** connecting Azure services → Azure Event Hub → OTEL Collector (Azure Container Instance) → Microsoft Fabric Real-Time Intelligence. The data flow is:

```
Azure Resources → Azure Event Hub → OTEL Collector Container → Microsoft Fabric (KQL Database) → Three OTEL tables
```

**Critical Components:**
- **Microsoft Fabric**: KQL database with three tables: `OTELLogs`, `OTELMetrics`, `OTELTraces`
- **OTEL Collector**: Containerized `otel/opentelemetry-collector-contrib` with Azure Event Hub receiver
- **Bicep Infrastructure**: Azure Verified Modules deployment for capacity, Event Hub, container instances
- **Fabric CLI**: PowerShell-based deployment automation using `fab` commands

## Development Workflows

### PowerShell-Only Architecture
This project **exclusively uses PowerShell scripts** - all Bash equivalents were removed. Key commands:

```powershell
# Full infrastructure deployment
cd deploy/infra/Bicep && .\deploy.ps1

# Fabric artifacts deployment (requires Fabric CLI)
.\deploy\infra\Deploy-FabricArtifacts-Git.ps1

# Comprehensive testing
.\tests\Test-FabricIntegration-Git.ps1
```

### Fabric CLI Authentication Pattern
```powershell
# Service principal (CI/CD)
fab auth login --service-principal --client-id $clientId --client-secret $clientSecret --tenant-id $tenantId

# Interactive (local dev)
fab auth login
fab auth whoami  # Always verify
```

### KQL Table Deployment Pattern
Tables use `.create-merge` commands for idempotency. Schema example from `deploy/fabric-artifacts/tables/otel-logs.kql`:
```kql
.create-merge table OTELLogs (
    Timestamp:datetime, 
    ObservedTimestamp:datetime, 
    TraceID:string, 
    SpanID:string, 
    SeverityText:string, 
    SeverityNumber:int, 
    Body:string, 
    ResourceAttributes:dynamic, 
    LogsAttributes:dynamic
)
```

## Project-Specific Conventions

### Default Environment Variables
```powershell
$env:FABRIC_WORKSPACE_NAME = "fabric-otel-workspace"
$env:FABRIC_DATABASE_NAME = "otelobservabilitydb" 
$env:RESOURCE_GROUP_NAME = "azuresamples-platformobservabilty-fabric"
$env:LOCATION = "swedencentral"
```

### Error Handling Pattern
PowerShell scripts use color-coded output functions:
```powershell
Write-ColorOutput "Success message" $ColorSuccess "✅"
Write-ColorOutput "Warning message" $ColorWarning "⚠️"
Write-ColorOutput "Error message" $ColorError "❌"
```

### Test Data Generation
The project includes sophisticated OTEL data generators in `tests/FabricObservability.IntegrationTests/Models/OtelModels.cs` with realistic service names, operations, and telemetry patterns.

## Development Environment

### **DevContainer-First Development Strategy**
This main branch focuses **exclusively on DevContainer-based development and testing**. GitHub Actions workflows have been moved to a separate branch to maintain CI/CD capabilities while keeping the main branch focused on local development experience.

**Branch Strategy:**
- **`main` branch**: DevContainer-focused development, local testing, sample validation
- **`ci-cd` branch**: GitHub Actions workflows and automated deployments
- **Focus**: Manual deployment testing and sample validation within DevContainer environment

### DevContainer Requirements
This project **exclusively runs within a DevContainer environment** on Linux. All commands, scripts, and tools are designed for Linux execution within the containerized development environment.

**Critical Environment Checks:**
- ✅ **Always verify DevContainer connection** before executing any commands
- ✅ **All terminal commands are Linux-based** (bash, not Windows CMD/PowerShell)
- ✅ **File paths use Linux conventions** (`/workspaces/azuresamples-fabric-observability/`)
- ✅ **PowerShell scripts run via `pwsh` (PowerShell Core)** not Windows PowerShell

**Environment Validation Commands:**
```bash
# Verify DevContainer connection
echo $PWD  # Should show /workspaces/azuresamples-fabric-observability
uname -a   # Should show Linux kernel information

# Verify required tools are available
az version      # Azure CLI
pwsh --version  # PowerShell Core
dotnet --version # .NET SDK
```

**Important Notes:**
- All file operations use Linux file system conventions
- PowerShell scripts are executed via `pwsh` command, not native Windows PowerShell
- Git operations use Linux git client within the container
- Azure CLI commands run in Linux environment with proper authentication context

## Integration Points

### OTEL Collector Configuration
`app/otel-eh-receiver/config.yaml` defines the gateway pipeline:
- **Receivers**: `otlp` (gRPC 4317) + `azureeventhub`
- **Processors**: `batch`
- **Exporters**: `debug` + `azuredataexplorer`

### GitHub Actions Integration
**Main Branch Strategy (Updated September 2024)**: DevContainer-focused validation workflow that eliminates Key Vault dependencies that were causing consistent failures.

**Cleaned Up Workflow (ci-cd-pipeline.yml)**:
1. **Unit Tests**: .NET xUnit professional testing framework (no Azure dependencies)
2. **Template Validation**: Bicep syntax validation without deployment
3. **Script Validation**: PowerShell script syntax checking
4. **Documentation Validation**: DevContainer setup and essential docs verification

**Removed Components** (moved to `ci-cd` branch pattern):
- Key Vault secret retrieval (was failing due to "Public network access disabled")
- Azure infrastructure deployment via Bicep
- Fabric artifacts deployment via Fabric CLI
- Azure authentication dependencies
- Integration testing requiring live Azure resources

**Key Benefits of Cleanup**:
- Eliminates cascade failures from Key Vault network restrictions
- Focuses on development environment validation
- Provides immediate feedback on code quality and syntax
- Aligns with DevContainer-first development approach
- Maintains professional testing standards without enterprise dependencies

### Bicep Module Structure
Infrastructure uses Azure Verified Modules pattern:
- `main.bicep` - Subscription-scoped orchestration
- `modules/fabriccapacity.bicep` - F2 SKU Fabric capacity
- `modules/eventhub.bicep` - Standard tier Event Hub
- `modules/containerinstance.bicep` - OTEL Collector container
- `modules/kqldatabase.bicep` - Fabric workspace and database parameters

## Critical File Locations

**Deployment Scripts**: `deploy/infra/Deploy-FabricArtifacts-Git.ps1` (Git integration), `deploy/infra/Install-FabricCLI.ps1` (legacy helper)
**KQL Definitions**: `deploy/fabric-artifacts/tables/*.kql` (Git integration)
**Test Suite**: `tests/Test-FabricIntegration-Git.ps1` (Git integration), `tests/FabricObservability.IntegrationTests/` (.NET)
**OTEL Config**: `app/otel-eh-receiver/config.yaml` (collector pipeline)
**Sample App**: `app/dotnet-client/OTELWorker/` (.NET worker with OTEL instrumentation)
**Git Integration**: `deploy/fabric-artifacts/` folder for Fabric workspace sync, `deploy/fabric-artifacts/README.md` (setup guide)

## Debugging Commands

```powershell
# Fabric connectivity
fab auth whoami
fab workspace list --output table
fab kqldatabase list --output table

# Azure resources
az resource list --resource-group $resourceGroupName --resource-type "Microsoft.Fabric/capacities"

# OTEL data verification in Fabric portal
# Navigate to: fabric.microsoft.com → workspace → database → run KQL:
# OTELLogs | count
# OTELMetrics | count  
# OTELTraces | count
```

## Git Workflow Requirements

**IMPORTANT**: After making any code changes, always test thoroughly before committing:

```bash
# 1. ALWAYS TEST FIRST - Execute relevant test scripts
./tests/Test-FabricIntegration-Git.ps1  # For Git integration changes

pwsh -c "script-name.ps1 -WhatIf"       # For deployment scripts

# 2. VERIFY FUNCTIONALITY - Ensure all tests pass and functionality works
# 3. ONLY THEN COMMIT - After successful testing

# Stage all changes
git add -A

# Commit with descriptive message explaining what was changed
git commit -m "Brief description of changes made"

# Push to remote repository
git push origin main
```

**TESTING REQUIREMENT**: Every code change must be tested and verified before committing. This includes:
- Running relevant test scripts to verify functionality
- Testing scripts with -WhatIf parameter when available
- Verifying that changes don't break existing functionality
- Ensuring all tests pass before proceeding to commit

This ensures code quality and prevents introducing untested changes to the repository.

## Development Best Practices & Context Management

### **DevContainer-First Approach**
- **All required libraries and tools** must be configured in DevContainer setup, not installed via separate scripts
- **Never create install scripts** - if tools are missing, update `.devcontainer/devcontainer.json` or `.devcontainer/post-create.sh` instead
- **Fabric CLI, Azure CLI, PowerShell, .NET, Git** are pre-installed via DevContainer configuration
- **Installation scripts are anti-pattern** - they violate the DevContainer-only approach

### **Fabric CLI Best Practices** 
**Always research Fabric CLI documentation online before implementing commands:**
- **Documentation**: https://microsoft.github.io/fabric-cli/ (main site)
- **Cheatsheet**: https://microsoft.github.io/fabric-cli/cheatsheet.html (all commands)  
- **Examples**: https://microsoft.github.io/fabric-cli/examples.html (usage patterns)
- **API Examples**: https://microsoft.github.io/fabric-cli/examples/api_examples.html (REST API usage)

**Key Fabric CLI Facts:**
- **File-system navigation**: Use `fab ls`, `fab cd`, `fab pwd` like bash commands
- **KQL Database queries**: Use `fab api` endpoint with workspace/database IDs, not names
- **Table command**: Only for Delta tables in Lakehouses, NOT KQL tables in databases  
- **API format**: `fab api "workspaces/{id}/kqldatabases/{id}/query" --method post --input "@file"`
- **Authentication**: `fab auth status` (not `fab auth whoami`)
- **Case sensitive**: `--method post` (lowercase), not `--method POST`

### **Documentation Consolidation Strategy**
- **All detailed documentation belongs in `docs/` folder** - specifically in `docs/README.md` as the comprehensive guide
- **Never create per-topic documentation files** (like README-Deploy-Complete.md, README-Destroy-Complete.md)
- **Update existing `docs/README.md`** with new sections instead of creating separate files
- **Brief overview files** in specific directories (like `deploy/infra/README.md`) should reference the consolidated docs
- **Use existing files where possible** rather than creating new documentation files
- **Centralized documentation pattern**: `docs/README.md` is the single comprehensive source

### **Git Repository Status Validation**
- **Always check current git status** before making assumptions about file structure
- **Deleted files may persist in IDE cache** - verify actual file existence with `ls` or `file_search` tools
- **Repository state changes frequently** - don't assume files exist based on previous conversations
- **Use `list_dir` and `grep_search`** to validate current project structure before making changes

### **Context Preservation**
- **Document significant architectural decisions** in this copilot-instructions.md file
- **Include change history** when patterns are established or modified
- **Reference previous decisions** explicitly when building on existing work
- **Maintain decision trail** for future context (what was changed and why)

**Recent Architectural Changes (September 2024)**:
- **GitHub Actions Cleanup**: Removed Key Vault dependencies that were causing "Public network access disabled" failures across all deployment jobs
- **DevContainer Focus**: Simplified main branch workflow to focus on local development validation rather than full CI/CD deployment
- **Folder Consolidation**: Moved `infra/` → `deploy/infra/` and `tools/` → `deploy/tools/` to create unified deployment structure
- **Branch Strategy Clarification**: Main branch for DevContainer development, `ci-cd` branch for enterprise deployment patterns
- **Documentation Consolidation Strategy**: All detailed documentation moved to `docs/README.md` - removed per-topic files like README-Deploy-Complete.md, README-Destroy-Complete.md in favor of single comprehensive guide
- **Unified Deployment Scripts**: Created Deploy-Complete.ps1 and Destroy-Complete.ps1 with centralized configuration integration
- **Git Integration Approach (September 2025)**: Replaced complex API-based deployment with Microsoft Fabric Git integration pattern using `fabric-artifacts/` folder, eliminating authentication and API complexity issues

### **Deployment Anti-Patterns to Avoid**
❌ **Complex API-based deployment** - Use Git integration instead  
❌ **Workspace ID lookups for deployment** - Git integration handles workspace automatically  
❌ **Manual authentication for deployment** - Git sync works through Fabric portal  
❌ **Complex PowerShell API calls** - Simple Git operations are more reliable  
❌ **API-based table creation** - Use DatabaseSchema.kql in Git folder  
❌ **Searching for workspace in deployment scripts** - Git integration connects automatically

### **Terminal Command Best Practices**
✅ **Execute commands individually** - one command per `run_in_terminal` call  
✅ **Check exit codes separately** - use `$LASTEXITCODE` or `$?` after each command  
✅ **Provide clear explanations** - each command should have a specific purpose  
✅ **Use absolute paths** - avoid relative path dependencies between commands  
✅ **Test command validity** - verify commands work before combining into scripts  

### **Validation Commands Before Major Changes**
```bash
# Check current directory structure
ls -la /workspaces/azuresamples-fabric-observability/

# Verify git status and recent changes
git status
git log --oneline -5

# Validate DevContainer tools
az --version && pwsh --version && dotnet --version && fab --version
```
